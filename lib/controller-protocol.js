// Generated by CoffeeScript 1.4.0

module.exports = function(subscribe, publish, edge, context) {
  var id, viewports;
  id = edge.localId();
  viewports = void 0;
  subscribe('event:register:controller', function(primaryViewportID) {
    var _base;
    context.gimbal || (context.gimbal = {});
    (_base = context.gimbal).controllers || (_base.controllers = {});
    context.gimbal.controllers[id] = {
      edge: edge,
      primary: primaryViewportID,
      viewports: []
    };
    context.gimbal.controllers[id].viewports.push(primaryViewportID);
    viewports = context.gimbal.controllers[id].viewports;
    return publish('event:register:controller:ok', primaryViewportID);
  });
  subscribe('event:release:controller', function(payload) {
    var send, viewportID, _i, _len;
    console.log('RECEIVED: event:release:controller');
    if (viewports) {
      for (_i = 0, _len = viewports.length; _i < _len; _i++) {
        viewportID = viewports[_i];
        send = context.gimbal.viewports[viewportID].getPublisher();
        send('event:reset', '');
      }
      viewports = void 0;
    }
    context.gimbal.controllers[id].disconnected = true;
    return publish('event:release:controller:ok');
  });
  return subscribe('event:controller', function(payload) {
    var event, send, viewportID, _i, _len, _results;
    console.log('RECEIVED: event:controller %s', JSON.stringify(payload));
    if (!viewports) {
      return;
    }
    _results = [];
    for (_i = 0, _len = viewports.length; _i < _len; _i++) {
      viewportID = viewports[_i];
      send = context.gimbal.viewports[viewportID].getPublisher();
      _results.push((function() {
        var _results1;
        _results1 = [];
        for (event in payload) {
          _results1.push(send(event, payload[event]));
        }
        return _results1;
      })());
    }
    return _results;
  });
};
